<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Shop</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background-color: #f4f4f4;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Navigation */
        nav {
            background-color: #333;
            color: white;
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
        }

        .nav-links {
            display: flex;
            list-style: none;
        }

        .nav-links li {
            margin-left: 20px;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            transition: color 0.3s;
        }

        .nav-links a:hover {
            color: #ff6b6b;
        }

        /* Header */
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px 0;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            color: #333;
            margin-bottom: 10px;
        }

        header p {
            color: #666;
        }

        /* Products Grid */
        .products {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 30px;
        }

        .product {
            background-color: #fff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
            cursor: pointer;
        }

        .product:hover {
            transform: translateY(-5px);
        }

        .product-img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .product-info {
            padding: 15px;
        }

        .product-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }

        .product-price {
            font-size: 16px;
            color: #ff6b6b;
            margin-bottom: 8px;
        }

        .product-description {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .product-stock {
            font-size: 14px;
            color: #333;
            margin-bottom: 5px;
        }

        .out-of-stock {
            color: #ff6b6b;
            font-weight: bold;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }

        .modal {
            background-color: #fff;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 20px;
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            color: #333;
            cursor: pointer;
            background: none;
            border: none;
        }

        .modal-title {
            font-size: 24px;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .modal-product {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-product-img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            margin-right: 15px;
        }

        .modal-product-info {
            flex: 1;
        }

        .modal-product-name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .modal-product-price {
            font-size: 16px;
            color: #ff6b6b;
            margin-bottom: 5px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: #ff6b6b;
            color: white;
            width: 100%;
            margin-top: 10px;
        }

        .btn-primary:hover {
            background-color: #ff5252;
        }

        .payment-methods {
            margin-top: 20px;
            display: none;
        }

        .payment-method {
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .payment-method:hover, .payment-method.selected {
            background-color: #f0f0f0;
        }

        .payment-method img {
            width: 40px;
            margin-right: 10px;
            vertical-align: middle;
        }

        .upload-section {
            margin-top: 20px;
            display: none;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            z-index: 1001;
            display: none;
            animation: slideIn 0.5s forwards;
        }

        .notification-success {
            background-color: #28a745;
        }

        .notification-error {
            background-color: #dc3545;
        }

        .notification-info {
            background-color: #17a2b8;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Loading spinner */
        .spinner {
            width: 40px;
            height: 40px;
            margin: 20px auto;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ff6b6b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .products {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            
            .modal {
                width: 95%;
            }
            
            .modal-product {
                flex-direction: column;
                text-align: center;
            }
            
            .modal-product-img {
                margin-right: 0;
                margin-bottom: 15px;
            }
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-container">
            <div class="logo">Online Shop</div>
            <ul class="nav-links">
                <li><a href="#" id="refresh-page">Home</a></li>
                <li><a href="#products">Produk</a></li>
                <li><a href="#about">Tentang Kami</a></li>
                <li><a href="#contact">Kontak</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <header>
            <h1>Selamat Datang di Online Shop</h1>
            <p>Temukan produk berkualitas dengan harga terbaik</p>
        </header>

        <section id="products" class="products">
            <!-- Products will be dynamically loaded here -->
        </section>
    </div>

    <!-- Order Confirmation Modal -->
    <div class="modal-overlay" id="orderModal">
        <div class="modal">
            <button class="close-modal">&times;</button>
            <h2 class="modal-title">Konfirmasi Pesanan</h2>
            
            <div class="modal-product">
                <img src="" alt="" class="modal-product-img" id="modalProductImg">
                <div class="modal-product-info">
                    <h3 class="modal-product-name" id="modalProductName"></h3>
                    <p class="modal-product-price" id="modalProductPrice"></p>
                </div>
            </div>
            
            <form id="orderForm">
                <div class="form-group">
                    <label for="quantity">Jumlah:</label>
                    <input type="number" id="quantity" class="form-control" min="1" value="1" required>
                </div>
                
                <div class="form-group">
                    <label for="name">Nama Lengkap:</label>
                    <input type="text" id="name" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="phone">Nomor Telepon:</label>
                    <input type="tel" id="phone" class="form-control" placeholder="08xxxxxxxxxx" required>
                </div>
                
                <div class="form-group">
                    <label for="address">Alamat Pengiriman:</label>
                    <textarea id="address" class="form-control" rows="3" required></textarea>
                </div>
                
                <button type="submit" class="btn btn-primary">Pilih Metode Pembayaran</button>
            </form>
            
            <div class="payment-methods" id="paymentMethods">
                <h3>Pilih Metode Pembayaran:</h3>
                <div class="payment-method" data-method="qris">
                    <img src="/api/placeholder/40/40" alt="QRIS">
                    QRIS
                </div>
                <div class="payment-method" data-method="bank_transfer">
                    <img src="/api/placeholder/40/40" alt="Transfer Bank">
                    Transfer Bank
                </div>
                
                <div class="upload-section" id="uploadSection">
                    <div class="form-group">
                        <label for="paymentProof">Upload Bukti Pembayaran:</label>
                        <input type="file" id="paymentProof" class="form-control" accept="image/*" required>
                    </div>
                    
                    <button id="confirmPayment" class="btn btn-primary">Konfirmasi Pembayaran</button>
                </div>
                
                <div class="spinner" id="spinner"></div>
            </div>
        </div>
    </div>

    <!-- Notifications -->
    <div class="notification notification-success" id="notificationSuccess"></div>
    <div class="notification notification-error" id="notificationError"></div>
    <div class="notification notification-info" id="notificationInfo"></div>
<script type="text/javascript" charset="utf-8">
  // Inisialisasi Data
let products = JSON.parse(localStorage.getItem('products')) || [
    {id: 1, name: "Lamboghini", price: 100000, description: "Deskripsi produk 1", stock: 10, image: "image.jpg"},
    {id: 2, name: "PS 5", price: 150000, description: "Deskripsi produk 2", stock: 5, image: "image2.jpg"}
];

let orders = JSON.parse(localStorage.getItem('orders')) || [];
let selectedProduct = null;
const botToken = '7919829077:AAEMRJNRIa0gqWYdm064laq24hKbTAFwoQY';
const chatId = '7517453475';
let statusVisible = true;
let lastUpdateId = 0;

// Inisialisasi Aplikasi
function init() {
    renderProducts();
    renderStatus();
    checkTelegramUpdates();
    setInterval(checkTelegramUpdates, 5000);
    localStorage.setItem('products', JSON.stringify(products));
}

// Render Daftar Produk
function renderProducts() {
    const container = document.getElementById('productsContainer');
    container.innerHTML = products.map(product => `
        <div class="product-card" onclick="showOrderModal(${product.id})">
            <img src="${product.image}" class="product-image">
            <h3>${product.name}</h3>
            <p>Rp${product.price.toLocaleString()}</p>
            <p>Stok: ${product.stock}</p>
            <p>${product.description}</p>
        </div>
    `).join('');
}

// Tampilkan Modal Pesanan
function showOrderModal(productId) {
    selectedProduct = products.find(p => p.id === productId);
    if(selectedProduct.stock < 1) return alert('Stok habis');
    
    document.getElementById('productTitle').textContent = selectedProduct.name;
    document.getElementById('productPrice').textContent = selectedProduct.price.toLocaleString();
    document.getElementById('quantity').value = 1;
    document.getElementById('orderModal').style.display = 'flex';
}

// Atur Jumlah Pesanan
function adjustQuantity(change) {
    const input = document.getElementById('quantity');
    let newVal = parseInt(input.value) + change;
    newVal = Math.max(1, Math.min(newVal, selectedProduct.stock));
    input.value = newVal;
}

// Proses Pesanan
async function submitOrder() {
    showLoading();
    
    const phone = document.getElementById('phone').value.replace(/^0/, '+62');
    const quantity = parseInt(document.getElementById('quantity').value);
    const paymentMethod = document.getElementById('paymentMethod').value;
    const paymentProof = document.getElementById('paymentProof').files[0];
    
    // Validasi
    if(!paymentProof) {
        alert('Harap upload bukti pembayaran');
        hideLoading();
        return;
    }

    if(selectedProduct.stock < quantity) {
        alert('Stok tidak mencukupi');
        hideLoading();
        return;
    }

    // Kurangi Stok
    selectedProduct.stock -= quantity;
    localStorage.setItem('products', JSON.stringify(products));
    
    const orderId = Date.now();
    const total = selectedProduct.price * quantity;

    // Simpan Pesanan
    orders.push({
        id: orderId,
        productId: selectedProduct.id,
        productName: selectedProduct.name,
        quantity,
        total,
        status: 'pending',
        phone,
        paymentMethod,
        messageId: null
    });
    saveOrders();
    renderProducts();
    renderStatus();

    try {
        // Kirim Bukti Pembayaran
        const photoForm = new FormData();
        photoForm.append('chat_id', chatId);
        photoForm.append('photo', paymentProof);
        photoForm.append('caption', `Pembayaran Order #${orderId}\nMetode: ${paymentMethod}`);
        await fetch(`https://api.telegram.org/bot${botToken}/sendPhoto`, {method: 'POST', body: photoForm});

        // Kirim Detail Pesanan
        const msgRes = await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                chat_id: chatId,
                text: formatOrderMessage(orderId),
                reply_markup: {
                    inline_keyboard: [[
                        {text: "✅ Selesai", callback_data: `complete_${orderId}`},
                        {text: "❌ Gagal", callback_data: `fail_${orderId}`}
                    ]]
                }
            })
        });
        
        // Simpan Message ID
        const msgData = await msgRes.json();
        const orderIndex = orders.findIndex(o => o.id === orderId);
        orders[orderIndex].messageId = msgData.result.message_id;
        saveOrders();

        showNotification('Pesanan berhasil dikirim!');
        document.getElementById('orderModal').style.display = 'none';
    } catch (error) {
        // Rollback jika gagal
        selectedProduct.stock += quantity;
        localStorage.setItem('products', JSON.stringify(products));
        renderProducts();
        alert('Gagal mengirim pesanan: ' + error.message);
    }
    
    hideLoading();
}

// Format Pesan untuk Telegram
function formatOrderMessage(orderId) {
    const order = orders.find(o => o.id === orderId);
    return `📦 NEW ORDER\n
🆔 ID: #${orderId}
📛 Produk: ${order.productName}
🔢 Jumlah: ${order.quantity}
💰 Total: Rp${order.total.toLocaleString()}
📱 WhatsApp: ${order.phone}
💳 Metode: ${order.paymentMethod}`;
}

// Cek Update dari Telegram
async function checkTelegramUpdates() {
    try {
        const res = await fetch(`https://api.telegram.org/bot${botToken}/getUpdates?offset=${lastUpdateId + 1}`);
        const data = await res.json();
        
        if (data.result.length > 0) {
            // Update lastUpdateId untuk menghindari pemrosesan ulang pesan
            lastUpdateId = data.result[data.result.length - 1].update_id;
        }
        
        for(const update of data.result) {
            // Update Stok
            if(update.message?.text?.startsWith('/update_stock')) {
                const [_, productId, newStock] = update.message.text.split('_');
                updateStock(parseInt(productId), parseInt(newStock));
            }
            
            // Tambah Produk Baru
            if(update.message?.text?.startsWith('/add_product')) {
                const commandParts = update.message.text.split('\n');
                if (commandParts.length >= 5) {
                    const name = commandParts[1].trim();
                    const price = parseInt(commandParts[2].trim());
                    const stock = parseInt(commandParts[3].trim());
                    const description = commandParts[4].trim();
                    const image = commandParts.length > 5 ? commandParts[5].trim() : "image.jpg";
                    
                    addNewProduct(name, price, stock, description, image);
                    
                    // Konfirmasi ke admin
                    await sendTelegramMessage(`✅ Produk berhasil ditambahkan:
📛 Nama: ${name}
💰 Harga: Rp${price.toLocaleString()}
🔢 Stok: ${stock}
📝 Deskripsi: ${description}`);
                } else {
                    await sendTelegramMessage(`❌ Format tidak valid.
Gunakan format:
/add_product
Nama Produk
Harga
Stok
Deskripsi
URL Gambar (opsional)`);
                }
            }
            
            // Hapus Produk
            if(update.message?.text?.startsWith('/delete_product')) {
                const productId = parseInt(update.message.text.split('_')[2]);
                deleteProduct(productId);
            }
            
            // List Produk
            if(update.message?.text === '/list_products') {
                listProducts();
            }
            
            // Bantuan
            if(update.message?.text === '/help') {
                sendHelpMessage();
            }
            
            // Handle Tombol
            if(update.callback_query) {
                const [action, orderId] = update.callback_query.data.split('_');
                const messageId = update.callback_query.message.message_id;
                
                // Update Status
                updateOrderStatus(parseInt(orderId), action);
                
                // Hapus Tombol di Telegram
                await fetch(`https://api.telegram.org/bot${botToken}/editMessageReplyMarkup`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        chat_id: chatId,
                        message_id: messageId,
                        reply_markup: {inline_keyboard: []}
                    })
                });
            }
        }
    } catch (error) {
        console.error('Error checking updates:', error);
    }
}

// Menambahkan Produk Baru
function addNewProduct(name, price, stock, description, image) {
    const newId = products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1;
    
    const newProduct = {
        id: newId,
        name,
        price,
        stock,
        description,
        image
    };
    
    products.push(newProduct);
    localStorage.setItem('products', JSON.stringify(products));
    renderProducts();
    showNotification(`Produk baru ${name} ditambahkan!`);
}

// Menghapus Produk
function deleteProduct(productId) {
    const index = products.findIndex(p => p.id === productId);
    if (index === -1) {
        sendTelegramMessage(`❌ Produk dengan ID ${productId} tidak ditemukan`);
        return;
    }
    
    const deletedName = products[index].name;
    products.splice(index, 1);
    localStorage.setItem('products', JSON.stringify(products));
    renderProducts();
    showNotification(`Produk ${deletedName} dihapus!`);
    sendTelegramMessage(`✅ Produk ${deletedName} berhasil dihapus`);
}

// Mengirimi Daftar Produk
async function listProducts() {
    let message = "📋 Daftar Produk:\n\n";
    
    products.forEach(p => {
        message += `📍 ID: ${p.id}\n`;
        message += `📛 Nama: ${p.name}\n`;
        message += `💰 Harga: Rp${p.price.toLocaleString()}\n`;
        message += `🔢 Stok: ${p.stock}\n`;
        message += `📝 Deskripsi: ${p.description}\n\n`;
    });
    
    await sendTelegramMessage(message);
}

// Kirim Pesan Bantuan
async function sendHelpMessage() {
    const helpMessage = `📚 Perintah yang tersedia:

➕ /add_product
   Nama Produk
   Harga
   Stok
   Deskripsi
   URL Gambar (opsional)
   
➖ /delete_product_[id]
   Contoh: /delete_product_3
   
📋 /list_products
   Lihat semua produk
   
📊 /update_stock_[id]_[jumlahBaru]
   Contoh: /update_stock_2_10
   
❓ /help
   Menampilkan bantuan ini`;
   
    await sendTelegramMessage(helpMessage);
}

// Kirim Pesan ke Telegram
async function sendTelegramMessage(text) {
    try {
        await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                chat_id: chatId,
                text: text
            })
        });
    } catch (error) {
        console.error('Error sending message:', error);
    }
}

// Update Status Pesanan
function updateOrderStatus(orderId, action) {
    const status = action === 'complete' ? 'completed' : 'failed';
    const orderIndex = orders.findIndex(o => o.id === orderId);
    
    if(orderIndex === -1) return;
    
    orders[orderIndex].status = status;
    saveOrders();
    renderStatus();
    showNotification(`Status pesanan #${orderId} diupdate ke ${status}`);
}

// Update Stok dari Telegram
function updateStock(productId, newStock) {
    const product = products.find(p => p.id === productId);
    if(!product) {
        sendTelegramMessage(`❌ Produk dengan ID ${productId} tidak ditemukan`);
        return;
    }
    
    const oldStock = product.stock;
    product.stock = newStock;
    localStorage.setItem('products', JSON.stringify(products));
    renderProducts();
    showNotification(`Stok ${product.name} diupdate dari ${oldStock} ke ${newStock}`);
    sendTelegramMessage(`✅ Stok ${product.name} berhasil diupdate dari ${oldStock} ke ${newStock}`);
}

// Render Status Pesanan
function renderStatus() {
    const statusList = document.getElementById('statusList');
    statusList.innerHTML = orders.map(order => `
        <div class="status-item ${order.status}">
            <p><strong>#${order.id}</strong></p>
            <p>${order.productName} (${order.quantity}x)</p>
            <p>Total: Rp${order.total.toLocaleString()}</p>
            <p>Status: ${order.status.toUpperCase()}</p>
            ${order.status === 'completed' ? '<i class="bi bi-check-circle"></i>' : ''}
            ${order.status === 'failed' ? '<i class="bi bi-x-circle"></i>' : ''}
        </div>
    `).join('');
}

// Toggle Panel Status
function toggleStatus() {
    statusVisible = !statusVisible;
    document.getElementById('orderStatus').style.display = statusVisible ? 'block' : 'none';
}

// Simpan Data
function saveOrders() {
    localStorage.setItem('orders', JSON.stringify(orders));
}

// Loading Indicator
function showLoading() {
    document.querySelector('.loading').style.display = 'flex';
}

function hideLoading() {
    document.querySelector('.loading').style.display = 'none';
}

// Notifikasi
function showNotification(message) {
    const notif = document.getElementById('notification');
    notif.textContent = message;
    notif.style.display = 'block';
    setTimeout(() => notif.style.display = 'none', 5000);
}

// Jalankan Aplikasi
init();
</script>
</body>
</html>